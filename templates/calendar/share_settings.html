{% extends "base.html" %}
{% load dict_extras %}
{% block content %}
<div class="container py-4">
    {% if messages %}
    <div class="my-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

  <h2 class="mb-4">ğŸ“¤ ì¼ì • ê³µìœ  ì„¤ì •</h2>

  <form method="post">
    {% csrf_token %}

    <!-- ê³µìœ  ìƒíƒœ í…Œì´ë¸” -->
    <h5 class="mb-3">í˜„ì¬ ê³µìœ  ì¤‘ì¸ ì‚¬ìš©ì</h5>
    <table class="table table-hover text-center align-middle">
    <thead class="table-light">
        <tr>
        <th>ì‚¬ìš©ì</th>
        <th>ëª¨ë‘ ì„ íƒ</th>
        {% for st in schedule_types %}
            <th>{{ st.name }}</th>
        {% endfor %}
        <th>ê¸°ë³¸ ë¶„ë¥˜</th>
        </tr>
    </thead>
    <tbody>
        {% for user in shared_users %}
        <tr>
        <td>{{ user.username }}</td>
        <td>
            <input type="checkbox" class="select-all-row" data-user="{{ user.id }}">
        </td>
        {% for st in schedule_types %}
            <td>
            <input type="checkbox"
                    name="share_{{ user.id }}_{{ st.id }}"
                    class="share-checkbox user-{{ user.id }}"
                    {% if shared_map|dict_get:user|dict_get:st %}checked{% endif %}>
            </td>
        {% endfor %}
        <td>
            <input type="checkbox"
                name="share_{{ user.id }}_null"
                class="share-checkbox user-{{ user.id }}"
                {% if shared_map|dict_get:user|dict_get:None %}checked{% endif %}>
        </td>
        </tr>
        {% endfor %}
    </tbody>
    </table>

    <div class="text-end mt-4">
      <button type="submit" name="action" value="save_all" class="btn btn-primary">
        ì „ì²´ ì €ì¥
      </button>
    </div>
    <hr class="my-4">

    <!-- ìƒˆë¡œìš´ ê³µìœ  ìœ ì € ì¶”ê°€ -->
    <h5 class="mb-3">ê³µìœ  ìœ ì € ì¶”ê°€</h5>
    <div class="row">
        <div class="col-md-5 mb-3">
            <label for="new_user" class="form-label">ì‚¬ìš©ì ID ì…ë ¥</label>
            <input type="text" name="new_user" id="new_user" class="form-control">
        </div>

      <div class="col-md-5 mb-3">
        <label for="new_schedule_type" class="form-label">ê³µìœ í•  ì¼ì • ë¶„ë¥˜</label>
            <select name="new_schedule_type" id="new_schedule_type" class="form-control">
            <option value="">--- ì„ íƒ ---</option>
            <option value="__all__">ëª¨ë“  ë¶„ë¥˜</option>
            <option value="__default__">(ê¸°ë³¸ ë¶„ë¥˜)</option>
            {% for st in schedule_types %}
                <option value="{{ st.id }}">{{ st.name }}</option>
            {% endfor %}
            </select>
      </div>
      <div class="col-md-2 d-flex align-items-end mb-3">
        <button type="submit" name="action" value="add_share" class="btn btn-success w-100">
          ì¶”ê°€
        </button>
      </div>
    </div>


  </form>
  <hr class="my-5">
    <h5 class="mb-3">ğŸ“¥ ê³µìœ  ë°›ì€ ì¼ì • í‘œì‹œ</h5>
    <p class="text-muted">ì•„ë˜ ì‚¬ìš©ìì˜ ì¼ì •ì€ ë‹¹ì‹ ì—ê²Œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤. ì›í•˜ëŠ” ì‚¬ìš©ìì˜ ì¼ì •ì„ ì²´í¬í•˜ì—¬ ìº˜ë¦°ë”ì— í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <form method="post" class="mb-4">
    {% csrf_token %}
    <input type="hidden" name="action" value="update_visible">

    {% for user in incoming_shared_users %}
        <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" name="visible_users" value="{{ user.id }}" id="vu{{ user.id }}"
                {% if user.id in visible_ids %}checked{% endif %}>
        <label class="form-check-label" for="vu{{ user.id }}">
            {{ user.username }}ì˜ ì¼ì •
        </label>
        </div>
    {% endfor %}
    <button type="submit" class="btn btn-outline-primary">í‘œì‹œ ì„¤ì • ì €ì¥</button>
    </form>

</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // ê° ì‚¬ìš©ìë³„ "ëª¨ë‘ ì„ íƒ" ìƒíƒœ ì´ˆê¸°í™”
  document.querySelectorAll('.select-all-row').forEach(selectAllCheckbox => {
    const userId = selectAllCheckbox.dataset.user;
    const checkboxes = document.querySelectorAll(`.share-checkbox.user-${userId}`);

    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);

    if (allChecked) {
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
    } else if (anyChecked) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = true;
    } else {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    }

    // í–‰ ì „ì²´ ì„ íƒ ê¸°ëŠ¥
    selectAllCheckbox.addEventListener('change', function () {
      checkboxes.forEach(cb => cb.checked = this.checked);
    });

    // ê° ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ "ëª¨ë‘ ì„ íƒ" ìƒíƒœ ì—…ë°ì´íŠ¸
    checkboxes.forEach(cb => {
      cb.addEventListener('change', function () {
        const all = Array.from(checkboxes).every(x => x.checked);
        const any = Array.from(checkboxes).some(x => x.checked);
        selectAllCheckbox.checked = all;
        selectAllCheckbox.indeterminate = !all && any;
      });
    });
  });
});
</script>

{% endblock %}